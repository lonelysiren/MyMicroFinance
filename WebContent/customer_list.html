<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<link rel="stylesheet" href="./lib/plugins/gird-system/css/bootstrap.css" />
		<link rel="stylesheet" href="./lib/plugins/layui2.0/css/layui.css" media="all" />
		<link rel="stylesheet" href="./lib/plugins/city/css/city.css" media="all" />
		<link rel="stylesheet" href="./lib/css/main.css" />
	</head>

	<body>
		<div class="admin-main">
			<blockquote class="layui-elem-quote">
				客户列表
				 <button type="button" class="layui-btn layui-btn-sm" style="float:right;margin:0;" id="add"> <i class="layui-icon">&#xe608;</i> 添加</button>
			</blockquote>
			<blockquote class="layui-elem-quote layui-quote-nm">
						<div class="layui-collapse">
				<div class="layui-colla-item">
    <h2 class="layui-colla-title">查询面板</h2>
    <div class="layui-colla-content layui-show">
    <form class="layui-form layui-form-pane" action="">
 <div class="row">
  	 <div class="col-md-3">
  	 <div class="layui-form-item" style="margin-bottom: 0px">
   		<label class="layui-form-label">姓名</label>
   		<div class="layui-input-block">
   		<input type="text" name="name" autocomplete="off" class="layui-input" placeholder="请输入客户姓名">
      </div>
      </div>
      </div>
      
  <div class="col-md-3">
   <label class="layui-form-label">客户经理</label>
       <div class="layui-input-block">
      <select id="user_id"name="sales_account_manager" >
        <option value="">请选择客户经理</option>
      </select>
    </div>
  </div>
   <div class="col-md-6">
  <div class="layui-form-item" style="margin-bottom: 0px">
  <div class="layui-inline">
    <label class="layui-form-label">金额</label>
    <div class="layui-input-inline" >
      <input type="text" name="price_min" placeholder="￥" autocomplete="off" class="layui-input">
    </div>
    <div class="layui-form-mid">-</div>
    <div class="layui-input-inline" >
      <input type="text" name="price_max" placeholder="￥" autocomplete="off" class="layui-input">
    </div>
  </div>
</div>
  </div>
  </div>
 <div class="row">
  	 <div class="col-md-3">
  	 <div class="layui-form-item" style="margin-bottom: 0px">
   		<label class="layui-form-label">身份证号</label>
   		<div class="layui-input-block">
   		<input type="text" name="name" autocomplete="off" class="layui-input" placeholder="请输入身份证号">
      </div>
      </div>
      </div>
      
  <div class="col-md-3">
   <label class="layui-form-label">还款状态</label>
       <div class="layui-input-block">
      <select id="pay_stauts" name="stauts" >
        <option value=""></option>
        <option value="0">北京</option>
        <option value="1">上海</option>
        <option value="2">广州</option>
        <option value="3">深圳</option>
        <option value="4">杭州</option>
      </select>
    </div>
  </div>
   <div class="col-md-6">
  <div class="layui-form-item" style="margin-bottom: 0px">
  <div class="layui-inline">
    <label class="layui-form-label">时间</label>
    <div class="layui-input-inline" >
      <input type="text" name="price_min" placeholder="￥" autocomplete="off" class="layui-input">
    </div>
    <div class="layui-form-mid">-</div>
    <div class="layui-input-inline" >
      <input type="text" name="price_max" placeholder="￥" autocomplete="off" class="layui-input">
    </div>
  </div>
 
</div>
  </div>
  </div>
  <div class="row">
  	 <div class="col-md-5">
  	 <div class="layui-form-item" style="margin-bottom: 0px">
   		<label class="layui-form-label">选择地区</label>
   		<div class="layui-input-block">
   		<input type="text" name="area" id="city" autocomplete="off" class="layui-input" placeholder="请选择地区">
   		</div>
      </div>
      </div>
      <div class="col-md-5">
  	
  	 <div class="layui-form-item" style="margin-bottom: 0px">
   		<label class="layui-form-label">所属公司</label>
   		<div class="layui-input-block">
   		<input type="text" name="name" autocomplete="off" class="layui-input" placeholder="请输入客户姓名">
   		</div>
      </div>
      </div>
      <div class="col-md-2">
  	
  	 <div class="layui-form-item " style="margin-bottom: 0px">
   		<div  class="layui-btn-group">
  <button lay-submit lay-filter="check" class="layui-btn">查询</button>
  <button type="reset" class="layui-btn">重置</button>
	</div>
      </div>
  </div>
  </div>
    </form>
    </div>
  </div>
				</div>
				</blockquote>
			<blockquote class="layui-elem-quote layui-quote-nm" id="total"></blockquote>
			<fieldset class="layui-elem-field">
				<legend>数据列表</legend>
				<div class="layui-field-box layui-form">
				<table id="customer_list" lay-filter="customer_list" class="layui-table admin-table"></table>
				</div>
			</fieldset>
			<div class="admin-table-page">
				<div id="paged" class="page" >
				</div>
			</div>
		</div>
		<script type="text/html" id="stauts">
<a  style="cursor:pointer;color:#0000CD" lay-event="stauts">{{=d.stauts_name.length==0?'未审核':d.stauts_name }}</a>
</script>
	<script type="text/html" id="paystauts">
   {{#  if( d.pay_stauts > 0){}}
 <a  style="cursor:pointer;color:#0000CD" lay-event="repay">{{=d.pay_stauts_name }}</a>
  {{#  } else { }}
 <a  style="cursor:pointer;color:#0000CD" lay-event="stauts">{{=d.stauts_name.length==0?'未审核':d.stauts_name }}</a>
  {{#  } }}
</script>
<script type="text/html" id="customer">
 <a  style="cursor:pointer;color:#0000CD" lay-event="customer" ">{{=d.customer_name}}</a>
</script>
<script type="text/html" id="idcard">
 {{#  if( d.image.length > 0){ }}
 <a  style="cursor:pointer;color:#0000CD" lay-event="idcard">查看|</a>
  {{#  }  }}
 <a  style="cursor:pointer;color:#0000CD" lay-event="upload">上传</a>
</script>
<script type="text/html" id="contarct">
{{#  if( d.contract_stauts == 1){ }}
 <a  style="cursor:pointer;color:#0000CD" lay-event="qianding">签订|</a>
  {{#  }  }}
{{#  if( d.contract_stauts == 2){ }}
 <a  style="cursor:pointer;color:#0000CD" lay-event="fangkuan">放款|</a>
  {{#  }  }}
 {{#  if( d.check_stauts == 4){  }}
 <a  style="cursor:pointer;color:#0000CD" lay-event="contract">查看</a>
  {{#  }  }}
</script>
		<script type="text/javascript" src="./lib/plugins/layui2.0/layui.js"></script>
		<script type="text/javascript"src="./lib/js/jquery-3.2.1.min.js"></script>
		<script type="text/javascript"src="./lib/js/jquery.cookie.js"></script>
		<script type="text/javascript">
		layui.config({
			base:'lib/js/'
		});
		layui.use(['laydate','table','element'],function(){
			var table = layui.table,
			laydate = layui.laydate,
			element = layui.element,
			form = layui.form,
			$ = layui.jquery,
			company_id = $('#company_id', window.parent.document).val()
			 table.render({
		url:'/customer_list',
		where:{'company_id':company_id},
		elem:'#customer_list',
		cols:[[ //标题栏
			{field:'customer_id',title:'id',width:50},
		    {field: 'customer_name', title: '姓名',toolbar: '#customer', width: 100},
		    {field: 'stauts', title: '还款状态', width: 90,toolbar: '#paystauts'},
		    {field: 'idcard_number', title: '身份证', width: 190},
		    {field: 'check_date',  title: '日期', width: 190},
		    {field: 'circle',  title: '周期', width: 80},
		    {field: 'amount',  title: '放款金额', width: 90},
		    {field: 'manager_name',  title: '业务员', width: 90},
		    {field: 'check_stauts',  title: '审批结果', width: 80,toolbar: '#stauts'},
		    {field: 'image2',  title: '客户照片', width: 80,toolbar:'#idcard'},
		    {field: 'image1',  title: '云数据', width: 80},
		    {field: 'customer_contract_id',  title: '合同', width: 100,toolbar:'#contarct'},
		  ]],
		  page:true,
		  size:"sm",
		  done:function(res, curr, count){
			  $("#total").html("客户总数:"+count+"&nbsp&nbsp&nbsp&nbsp已放款总额:");
      	  }
				})
				table.on('tool(customer_list)', function(obj){
					 var data = obj.data; //获得当前行数据
					  var layEvent = obj.event; //获得 lay-event 对应的值
					  var tr = obj.tr; //获得当前行 tr 的DOM对象
					  if(layEvent=='customer'){
						  var load = layer.load(2, {time: 2*1000});
						  $.get('/customer_detail', {"customer_id":data.customer_id,"company_id":company_id}, function(form) {
					   			var addBoxIndex = layer.open({
					   				type: 1,
					   				title: '编辑客户资料',
					   				content: form,
					   				btn: ['确定', '取消'],
					   				shade: false,
					   				offset: ['0%', '0%'],
					   				area: ['100%', '100%'],
					   				zIndex: 500,
					   				maxmin: true,
					   				 btnAlign: 'c',
					   				yes: function(index) {
					   					//触发表单的提交事件
					   					$('form.layui-form').find('button[lay-filter=edit]').click();
					   				},
					   				full: function(elem) {
					   					var win = window.top === window.self ? window : parent.window;
					   					$(win).on('resize', function() {
					   						var $this = $(this);
					   						elem.width($this.width()).height($this.height()).css({
					   							top: 0,
					   							left: 0
					   						});
					   						elem.children('div.layui-layer-content').height($this.height() - 95);
					   					});
					   				},
					   				success: function(layero, index) {
					   					layer.close(load);
					   					layer.full(index);
					   					var btn = layero.find('.layui-layer-btn');
					   						return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。									
					   				},
					   				end: function() {
					   					addBoxIndex = -1;
					   				}
					   			});
					   		});
					  }else if (layEvent=="stauts"){
						  var load = layer.load(2, {time: 2*1000});
						  $.get('/customer_verify', {"customer_id":data.customer_id,"company_id":company_id}, function(form) {
					   			var addBoxIndex = layer.open({
					   				type: 1,
					   				title: '客户审核',
					   				content: form,
					   				shade: false,
					   				offset: ['0%', '0%'],
					   				area: ['100%', '100%'],
					   				zIndex: 500,
					   				maxmin: true,
					   				 btnAlign: 'c',
					   				yes: function(index) {
					   					//触发表单的提交事件
					   					$('form.layui-form').find('button[lay-filter=edit]').click();
					   				},
					   				success: function(layero, index) {
					   					layer.close(load);
					   					layer.full(index);
					   					var btn = layero.find('.layui-layer-btn');						
					   						return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。									
					   				},
					   				end: function() {
					   					addBoxIndex = -1;
					   					table.reload('customer_list',{
					   						where:{
					   							'company_id':company_id
					   						}
					   					});
					   				}
					   			});
					   		});
					  }else if(layEvent=="contract") {
						  $.get('/contract_detail', {"customer_id":data.customer_id,"company_id":company_id}, function(form) {
					   			var addBoxIndex = layer.open({
					   				type: 1,
					   				title: '合同查看',
					   				content: form,
					   				shade: false,
					   				offset: ['0%', '0%'],
					   				area: ['100%', '100%'],
					   				zIndex: 500,
					   				maxmin: true,
					   				 btnAlign: 'c',
					   				yes: function(index) {
					   					$('form.layui-form').find('button[lay-filter=edit]').click();
					   				},
					   				success: function(layero, index) {
					   					layer.close(load);
					   					layer.full(index);
					   					var btn = layero.find('.layui-layer-btn');						
					   						return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。									
					   				},
					   				end: function() {
					   					addBoxIndex = -1;
					   					}
					   				});
						  });
					  }else if(layEvent == "qianding" || layEvent =="fangkuan" ) {
						  var op = layEvent == "qianding"?"签订合同":"放款";
						  layer.confirm(
							  '是否确认进行 '+ op+' 操作!', {
								  btn: ['确定', '取消'],
							  icon: 3, 
							  title:'操作确认'
							  }
							, function(index, layero){
								 $.ajax({
									  type:"post",
									  url:"/contract_set",
									  data:{"customer_id":data.customer_id,"company_id":company_id,"op":layEvent},
								 success:function(data){
									 layer.msg(data);
									 layer.close(index);
									 table.reload('customer_list',{
					   						where:{
					   							'company_id':company_id
					   						}
					   					});
								 }
								  })
							}, function(index){
							  //按钮【按钮二】的回调
							});
						 
					  }else if(layEvent == "idcard"){
						  
					  }else if(layEvent == "upload"){
						  
					  }else if (layEvent == "repay"){
						  var load = layer.load(2, {time: 2*1000});
						  $.get('/customer_repay', {"customer_id":data.customer_id,"company_id":company_id,"idcard_number":data.idcard_number,"customer_name":data.customer_name}, function(form) {
					   			var addBoxIndex = layer.open({
					   				type: 1,
					   				title: '  ',
					   				content: form,
					   			//	btn: ['确定', '取消'],
					   				shade: false,
					   				offset: ['0%', '0%'],
					   				area: ['100%', '100%'],
					   				zIndex: 500,
					   				maxmin: true,
					   				full: function(elem) {
					   					var win = window.top === window.self ? window : parent.window;
					   					$(win).on('resize', function() {
					   						var $this = $(this);
					   						elem.width($this.width()).height($this.height()).css({
					   							top: 0,
					   							left: 0
					   						});
					   						elem.children('div.layui-layer-content').height($this.height() - 95);
					   					});
					   				},
					   				success: function(layero, index) {
					   					layer.close(load);
					   					layer.full(index);
					   					var btn = layero.find('.layui-layer-btn');
					   						return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。									
					   				},
					   				end: function() {
					   					addBoxIndex = -1;
					   				}
					   			});
					   		});
					  }
				})
				form.on('submit(check)', function(data){
					  console.log(data.elem) //被执行事件的元素DOM对象，一般为button对象
					  console.log(data.form) //被执行提交的form对象，一般在存在form标签时才会返回
					  console.log(data.field) //当前容器的全部表单字段，名值对形式：{name: value}
					  return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
					});
		});
		
		</script>
		
	</body>

</html>