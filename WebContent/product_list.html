<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>table模块快速使用</title>
  <link rel="stylesheet" href="./lib/plugins/layui2.0/css/layui.css" media="all" />
</head>
<body>
 
<div class="admin-main">
<blockquote class="layui-elem-quote">
				合同信息
				<button type="button" class="layui-btn layui-btn-small" style="float:right;margin:0;" id="mproduct"> 产品信息</button>
			</blockquote>
			 <fieldset class="layui-elem-field">
			 <legend>合同信息设置</legend>
<form class="layui-field-box  layui-form" id="company_info" >
<div class=" layui-row">
	  <div class="layui-col-md5">
		<div class="layui-form-item">
			<label class="layui-form-label" style="text-align: left;width:100px">公司名称：</label>
			<div class="layui-input-block" style="margin-left: 130px">
				<input type="text"  lay-verify="required"name="company_name"   autocomplete="off" class="layui-input">
			</div>
		</div>
		</div>
		  <div class="layui-col-md5">
		<div class="layui-form-item">
			<label class="layui-form-label" style="text-align: left;width:120px">还款用户名：</label>
			<div class="layui-input-block" style="margin-left: 150px">
				<input type="text" lay-verify="required" name="company_man"   autocomplete="off" class="layui-input">
			</div>
		</div>
		</div>
		</div>
		<div class=" layui-row">
	  <div class="layui-col-md5">
		<div class="layui-form-item">
			<label class="layui-form-label" style="text-align: left;width:100px">公司地址：</label>
			<div class="layui-input-block" style="margin-left: 130px">
				<input type="text" lay-verify="required"  name="company_address"   autocomplete="off" class="layui-input">
			</div>
		</div>
		</div>
		  <div class="layui-col-md5">
		<div class="layui-form-item">
			<label class="layui-form-label" style="text-align: left;width:120px">违约金每天：</label>
			<div class="layui-form-mid layui-word-aux" style="margin-right: 0px">百分之</div>
			<div class="layui-input-block" style="margin-left: 210px">
				<input type="text" lay-verify="required" name="company_overfeeday"   autocomplete="off" class="layui-input">
			</div>
		</div>
		</div>
		</div>
		<div class=" layui-row">
	  <div class="layui-col-md5">
		<div class="layui-form-item">
			<label class="layui-form-label" style="text-align: left;width:100px">联系电话：</label>
			<div class="layui-input-block" style="margin-left: 130px">
				<input type="text" lay-verify="required" name="compnay_telphone"   autocomplete="off" class="layui-input">
			</div>
		</div>
		</div>
		  <div class="layui-col-md5">
		<div class="layui-form-item">
			<label class="layui-form-label" style="text-align: left;width:120px">提前结清违约金：</label>
			<div class="layui-form-mid layui-word-aux" style="margin-right: 0px">百分之</div>
			<div class="layui-input-block" style="margin-left: 210px">
				<input type="text" lay-verify="required" name="company_overfeetime"   autocomplete="off" class="layui-input">
			</div>
		</div>
		</div>
		</div>
	<div class=" layui-row">
	  <div class="layui-col-md5">
		<div class="layui-form-item">
			<label class="layui-form-label" style="text-align: left;width:100px">还款银行名称：</label>
			<div class="layui-input-block" style="margin-left: 130px">
				<input type="text" lay-verify="required" name="company_bankname"   autocomplete="off" class="layui-input">
			</div>
		</div>
		</div>
		  <div class="layui-col-md5">
		<div class="layui-form-item">
			<label class="layui-form-label" style="text-align: left;width:120px">提前结清期数：</label>
			<div class="layui-input-block" style="margin-left: 150px">
				<input type="text" lay-verify="required" name="company_tiqianshu"   autocomplete="off" class="layui-input">
			</div>
		</div>
		</div>
		</div>
		<div class=" layui-row">
	  <div class="layui-col-md5">
		<div class="layui-form-item">
			<label class="layui-form-label" style="text-align: left;width:100px">还款卡号：</label>
			<div class="layui-input-block" style="margin-left: 130px">
				<input type="text" lay-verify="required" name="company_conunt"   autocomplete="off" class="layui-input">
			</div>
		</div>
		</div>
		  <div class="layui-col-md5">
		<div class="layui-form-item">
			<label class="layui-form-label" style="text-align: left;width:120px">还款日期截止：</label>
			<div class="layui-input-block" style="margin-left: 150px">
				<input type="text" lay-verify="required" name="company_repaydate"   autocomplete="off" class="layui-input">
			</div>
		</div>
		</div>
		</div>
		<div class=" layui-row">
	  <div class="layui-col-md5">
		<div class="layui-form-item">
			<label class="layui-form-label" style="text-align: left;width:100px">微信：</label>
			<div class="layui-input-block" style="margin-left: 130px">
				<input type="text" lay-verify="required" name="company_wechat"   autocomplete="off" class="layui-input">
			</div>
		</div>
		</div>
		  <div class="layui-col-md5">
		<div class="layui-form-item">
			<label class="layui-form-label" style="text-align: left;width:120px">逾期最长天数：</label>
			<div class="layui-input-block" style="margin-left: 150px">
				<input type="text" lay-verify="required" name="company_overmaxday"   autocomplete="off" class="layui-input">
			</div>
		</div>
		</div>
		</div>
		<div class=" layui-row">
	  <div class="layui-col-md5">
		<div class="layui-form-item">
			<label class="layui-form-label" style="text-align: left;width:100px">支付宝：</label>
			<div class="layui-input-block" style="margin-left: 130px">
				<input type="text" lay-verify="required" name="company_alipay"   autocomplete="off" class="layui-input">
			</div>
		</div>
		</div>
		</div>
		<div class=" layui-row">
	  <div class="layui-col-md5">
		<div class="layui-form-item">
			<label class="layui-form-label" style="text-align: left;width:100px">初始投资：</label>
			 <div class="layui-input-inline">
      <input type="text" lay-verify="required" name="company_beginfee"  autocomplete="off" class="layui-input">
    </div>
    <div class="layui-form-mid layui-word-aux">元</div>
		</div>
		</div>
		</div>
		<div class=" layui-row">
	  <div class="layui-col-md5">
		<div class="layui-form-item">
			<label class="layui-form-label" style="text-align: left;width:100px">已经运营费用：</label>
			 <div class="layui-input-inline">
      <input type="text" lay-verify="required"  name="company_runfee"  autocomplete="off" class="layui-input">
    </div>
    <div class="layui-form-mid layui-word-aux">元</div>
		</div>
		</div>
		</div>
		<div class=" layui-row">
	  <div class="layui-col-md5">
		<div class="layui-form-item">
			<label class="layui-form-label" style="text-align: left;width:100px">公众号客户直接提交认证：</label>
			 <div class="layui-input-block">
      <input type="radio" name="company_renzheng" value="1" title="是">
<input type="radio" name="company_renzheng" value="0" title="否" checked>
    </div>
		</div>
		</div>
		</div>
		<div class=" layui-row">
	  <div class="layui-col-md5">
		<div class="layui-form-item" >
			<label class="layui-form-label" style="text-align: left;width:100px">还款二维码：</label>
			<input type="hidden" name="qrcode">
			 <div class="layui-input-block" style="margin-left: 130px; ">
			 <div style="width:250px;height:250px;border:1px solid #000;">
			 <img  id="qrimg"alt="" src="/lib/images/qrcode.png">
			 <img  id="upqr" src="" style="display:none;">
			 </div>
    </div>
		</div>
		</div>
		 <div class="layui-col-md1" >
			  <button type="button" class="layui-btn" id="upload">
  <i class="layui-icon">&#xe67c;</i>上传图片
</button>
    </div>
		</div>
		<div class=" layui-row">
	  <div class="layui-col-md10">
		<div class="layui-form-item">
			<label class="layui-form-label" style="text-align: left;width:100px">其他：</label>
			 <div class="layui-input-block" style="margin-left: 130px">
			 <textarea id="other" name="company_remark" style="display: none;"></textarea>
    </div>
    </div>
		</div>
		</div>
		<div class="layui-row">
	<div class="layui-col-md1 layui-col-md-offset9">
      <button class="layui-btn" style="float:right" id="save"lay-submit  lay-filter="save">保存</button>
	</div>
	</div>
</form>
 </fieldset>
			<blockquote id="product_info"class="layui-elem-quote">
				产品信息
				 <button type="button" class="layui-btn layui-btn-small" style="float:right;" id="reload"> <i class="layui-icon">&#x1002;</i> 刷新</button>
				 <button type="button" class="layui-btn layui-btn-small" style="float:right;margin-right: 10px;" id="add"> <i class="layui-icon">&#xe608;</i> 添加</button>
				 
			</blockquote>
			<fieldset class="layui-elem-field">
				<legend>产品列表</legend>
				<div class="layui-field-box layui-form">
					<table id="product_list"  lay-filter="product_list" class="layui-table admin-table">
					</table>
				</div>
			</fieldset>
			
		</div>
 <script type="text/html" id="barDemo">
  <a class="layui-btn layui-btn-mini" lay-event="edit">编辑</a>
  <a class="layui-btn layui-btn-danger layui-btn-mini" lay-event="del">删除</a>
</script>
<script type="text/html" id="isAdvance">
  {{#  if(d.product_isAdvance == 1){ }}
  	  是
  {{#  } else { }}
否
  {{#  } }}
</script>
    <script type="text/html" id="product_payment_method">
  {{#  if(d.product_payment_method == 1){ }}
  	  等额本息
  {{#  } else { }}
等额本金
  {{#  } }}
</script> 
	<script type="text/javascript" src="./lib/plugins/layui2.0/layui.js"></script>
<script>
function checkImgPX(ths, width, height) {  
    var img = null;  
    img = document.createElement("img");  
    console.log(img)
    document.body.insertAdjacentElement("beforeEnd", img); // firefox不行  
    img.style.visibility = "hidden";   
    img.src = ths;  
    var imgwidth = img.offsetWidth;  
    var imgheight = img.offsetHeight;  
    if(imgwidth > width || imgheight > height) {  
        alert("图的尺寸应该小于" + width + "x"+ height);  
        ths.value = "";  
        return false;  
    }  
    return true;  
}  
layui.config({
	base:'lib/js/'
});
layui.use(['paging','element','layedit','upload'],function(){
	var paging = layui.paging(),
	element = layui.element,
	form = layui.form,
	$ = layui.jquery,
	upload = layui.upload,
	company_id = $('#company_id', window.parent.document).val(),
	fieldElem = $('#company_info').find('input,select,textarea');
	var uploadInst = upload.render({
	    elem: '#upload' //绑定元素
	    ,url: '/upload_qrcode' //上传接口
	    ,data:{'company_id':company_id}
	 	,auto: false //选择文件后不自动上传
	 	,size:500
	 	,exts:'jpg|png|jpeg'
	 	,choose: function(obj){
	 	    //将每次选择的文件追加到文件队列
	 	    var files = obj.pushFile();
	 	    //预读本地文件，如果是多文件，则会遍历。(不支持ie8/9)
	 	    obj.preview(function(index, file, result){
	 	      console.log(index); //得到文件索引
	 	      console.log(file); //得到文件对象
	 	   if(checkImgPX(result,250,250)){
	 		  obj.upload(index, file);
	 	   }
	 	      //这里还可以做一些 append 文件列表 DOM 的操作
	 	      //obj.upload(index, file); //对上传失败的单个文件重新上传，一般在某个事件中使用
	 	      //delete files[index]; //删除列表中对应的文件，一般在某个事件中使用
	 	    })}
	  	,before: function(obj){ //obj参数包含的信息，跟 choose回调完全一致，可参见上文。
		    layer.load(); //上传loading
		  }
	    ,done: function(res){
	      //上传完毕回调
	       layer.closeAll('loading'); //关闭loading
	    }
	    ,error: function(){
	       layer.closeAll('loading'); //关闭loading
	      //请求异常回调
	    }
	  });
		 $.ajax({
			type:'post',
			url:'/company_info',
			data:{'company_id':company_id},
				success: function (result) {
					 layui.each(fieldElem,function(key,item){
						 if(!item.name) return;
					      if(/^checkbox|radio$/.test(item.type) && !item.checked) return;
					      if(!result[item.name]) return;
					      fieldElem.eq(key).val(result[item.name]);
					      field[item.name] = result[item.name];
					      form.render();
					}) 
                },
                error: function (result, status) { }
		});  
	var layedit = layui.layedit,
	  edit = layedit.build('other',{tool: [
		  'strong' //加粗
		  ,'italic' //斜体
		  ,'underline' //下划线
		  ,'del' //删除线
		  ,'|' //分割线
		  ,'left' //左对齐
		  ,'center' //居中对齐
		  ,'right' //右对齐
		  ,'link' //超链接
		  ,'unlink' //清除链接
		]}); //建立编辑器
		$('#save').click(function(){
			layedit.sync(edit)
		})
	  form.on('submit(save)',function(data){
		 
		  layui.each(data.field,function(key,value){
			  console.log(key,value,field[key])
			  if(!field[key] == undefined) return
			  if(value != field[key]) return
				 delete data.field[key]
		  })
			if(isEmptyObject(data.field)) return false
			data.field['company_id'] = company_id;
			$.ajax({
				type:'post',
				url:'/company_edit',
				data:data.field,
					success: function (result) {
						if(result == 'error'){
							$(':password').val('');
							$(':text').val( $.cookie('rememberMe'));
							form.render();
							layer.msg('用户名或密码错误,请重新输入');
						}else if(result == 'stauts') {
							$(':password').val('');
							$(':text').val( $.cookie('rememberMe'));
							form.render();
							layer.msg('此账号已被禁用');
						}
						else{
							window.location.href='index.jsp';
						}
	                },
	                error: function (result, status) { }
			});
			return false
	  })
	paging.init({
		url:'/product_list',
		where:{'company_id':$('#company_id', window.parent.document).val()},
		elem:'#product_list',
		cols:[[ //标题栏
		    {field: 'product_id', title: 'ID', width: 80},
		    {field: 'product_name', title: '产品名称', width: 120},
		    {field: 'product_cycle', title: '周期天数', width: 100},
		    {field: 'product_day_rate',  title: '日息', width: 80},
		    {field: 'product_week_rate',  title: '周息', width: 80},
		    {field: 'product_margin_loans', title: '保证金', width: 80},
		    {field: 'product_management_pay', title: '管理费', width: 80},
		    {field: 'product_other_pay', title: '其他费用', width: 100},
		    {field: 'product_payment_method',templet: '#product_payment_method', title: '还款方式', width: 120},
		    {field: 'product_isAdvance',templet: '#isAdvance', title: '提前还款', width: 100},
		    {field: 'product_remark', title: '备注', width: 120},
		    {fixed: 'right',title:'操作', width:130, align:'center', toolbar: '#barDemo'} 
		  ]],
		  filter:'product_list',
		  add:{'url':'/product_add','company_id':company_id},
		  del:{'name':'product_name','id':'product_id','url':'/product_del'},
		  edit:{'page':'./lib/temp/edit-product.html','url':'/product_edit'},
		  render:function(odata){
			 		 $("select[name='product_payment_method']").val(odata['product_payment_method']);
					$("#product_remark").val(odata['product_remark']);
		  }
	})
	
	$('#mproduct').click(function(){
		$("html,body").animate({scrollTop:$("#product_info").offset().top},200);
	})
	$('#reload').click(function(){
		paging.reload()
	})
})
</script>
</body>
</html>